# EXP-003: TTA (Test Time Augmentation)

## 📋 실험 정보

| 항목 | 내용 |
|------|------|
| **실험 번호** | EXP-003 |
| **실험 날짜** | 2025-10-29 |
| **베이스 코드** | EXP-002 (프레임 40) |
| **주요 변경** | TTA - 좌우 반전 앙상블 |
| **F1 Score** | 제출 대기... |
| **베이스라인 대비** | 제출 대기... |
| **추론 시간** | 예상 140~160분 (2배) |

---

## 🎯 실험 목적

**추론 시 데이터 증강으로 예측 안정성 및 정확도 향상**

- EXP-002 기반 (프레임 40)
- 원본 + 좌우 반전 앙상블
- 모델 변경 없이 추론만 개선
- 검증된 기법으로 리스크 낮음

---

## 🔧 모델 아키텍처

### 사용 모델
- **백본**: `google/vit-base-patch16-224-in21k`
- **모델**: `deep-fake-detector-v2-model` (EXP-002와 동일)
- **입력 크기**: 224x224
- **출력**: Binary Classification (Real:0, Fake:1)

### 모델 파라미터
```python
model = ViTForImageClassification.from_pretrained(model_path).to("cuda")
processor = ViTImageProcessor.from_pretrained(model_path)
model.eval()
```

---

## 🔄 파이프라인 상세

### 1️⃣ 전처리 (Pre-processing)

#### EXP-002와 동일
```python
- NUM_FRAMES = 40
- margin = 1.3
- 얼굴 미검출 → 레이블 0
- 프레임 균등 샘플링
```

**변경 사항**: 없음

---

### 2️⃣ 모델링 (Modeling)

#### TTA (Test Time Augmentation) 적용 ⭐ **핵심 변경**

```python
# 기존 (EXP-002)
inputs = processor(images=face_images)
outputs = model(inputs)
probs = softmax(outputs)
final = mean(probs)

# EXP-003: TTA 추가
tta_images = []

# 1. 원본 이미지
tta_images.extend(face_images)

# 2. 좌우 반전 이미지
flipped_images = [img.transpose(Image.FLIP_LEFT_RIGHT) 
                  for img in face_images]
tta_images.extend(flipped_images)

# 원본 + 반전 모두 추론
inputs = processor(images=tta_images)
outputs = model(inputs)
probs = softmax(outputs)

# 평균 (원본 + 반전)
final = mean(probs)
```

#### 작동 원리
```
비디오 (40프레임):
├─ 원본 40프레임 → 모델 예측 (40개)
└─ 반전 40프레임 → 모델 예측 (40개)
    ↓
총 80개 예측 평균 → 최종 예측
```

#### 모델 파라미터
| 파라미터 | 값 | EXP-002 대비 |
|---------|-----|-------------|
| 모델 | ViT-Base | 동일 |
| TTA | 좌우 반전 | **추가** ⭐ |
| Batch Processing | 사용 | 동일 |
| 추론 횟수 | 2배 (원본+반전) | **2배** |

**변경 사항**: TTA 추가 (원본 + 좌우 반전)

**예상 효과**: +1~3% (앙상블 효과)

---

### 3️⃣ 후처리 (Post-processing)

#### 예측 집계 (Aggregation)
```python
# 원본 + 반전 모두 평균
avg_probs = probs.mean(dim=0)  # 80개 예측 평균 (40 원본 + 40 반전)
predicted_class = torch.argmax(avg_probs).item()
```

#### 얼굴 미검출 처리
```python
if not face_images:
    results_to_write[filename] = 0  # Real로 분류 (EXP-002와 동일)
```

#### 후처리 파라미터
| 파라미터 | 값 | EXP-002 대비 |
|---------|-----|-------------|
| 집계 방법 | Mean only | 동일 |
| TTA 앙상블 | 원본 + 반전 평균 | **추가** ⭐ |
| 얼굴 미검출 | 레이블 0 | 동일 |

**변경 사항**: TTA 앙상블 (원본 + 반전 평균)

**예상 효과**: +1~2% (예측 안정성)

---

## 🔄 베이스라인 대비 변경 사항

### 변경 요약

| 단계 | 변경 항목 | EXP-002 | EXP-003 | 영향 |
|------|----------|---------|---------|------|
| 전처리 | NUM_FRAMES | 40 | 40 | - |
| 모델링 | TTA | 없음 | **좌우 반전** | ⬆️⬆️ |
| 후처리 | 앙상블 | Mean only | **Mean (원본+반전)** | ⬆️ |

### 변경점 상세 분석

#### ✅ 핵심 변경: TTA (Test Time Augmentation)

**원리**:
```
같은 이미지, 다른 각도:
- 원본: 얼굴 왼쪽 → Fake 0.6
- 반전: 얼굴 오른쪽 → Fake 0.8
- 평균: (0.6 + 0.8) / 2 = 0.7 ✅ 더 확신!
```

**장점**:
- ✅ 모델 학습 불필요 (추론만 변경)
- ✅ 예측 안정성 향상
- ✅ 검증된 기법 (CV 대회 필수)
- ✅ 코드 수정만 (1시간)

**단점**:
- ⚠️ 추론 시간 2배 (70분 → 140~160분)
  - 하지만 3시간 제한 안에 충분히 여유 있음

#### 🔍 왜 좌우 반전인가?

1. **얼굴의 좌우 대칭성**
   - 얼굴은 좌우 대칭
   - 반전해도 동일한 사람
   - 딥페이크 아티팩트도 유사하게 보임

2. **다양한 각도 커버**
   - 왼쪽 치우침 → 오른쪽 치우침
   - 모델이 더 robust하게 판단

3. **검증된 효과**
   - 대부분의 CV 대회에서 효과 확인
   - 이미지 분류에서 1~3% 향상

---

## 📊 결과

### 정량적 결과

| 메트릭 | EXP-002 | EXP-003 | 변화 |
|--------|---------|---------|------|
| **Macro F1** | 대기중... | 대기중... | 대기중... |
| **정확도 추정** | - | - | - |
| **추론 시간** | 85~90분 | 예상 140~160분 | +55~70분 |

### 정성적 분석

**예상 결과**:
1. **성능 향상 예상**: F1 +1~3% (0.59~0.61 목표)
2. **안정적 예측**: 원본+반전 평균으로 노이즈 감소
3. **검증된 기법**: CV 대회에서 필수적으로 사용

---

## 🔍 상세 분석

### 성능 영향 요인 분석

#### 1. TTA의 앙상블 효과

**가설**:
```
원본과 반전의 평균 → 예측 안정성 ⬆️ → 성능 ⬆️
```

**메커니즘**:
- 원본: 특정 각도에서의 예측
- 반전: 반대 각도에서의 예측
- 평균: 두 각도의 종합 판단 → 더 robust

**예상 시나리오**:
```
Case 1: 모델이 확신 있는 경우
- 원본: Fake 0.9
- 반전: Fake 0.85
- 평균: 0.875 (여전히 높은 확신)

Case 2: 모델이 애매한 경우
- 원본: Fake 0.55
- 반전: Fake 0.65
- 평균: 0.60 (더 안정적인 예측)

Case 3: 모델이 틀린 경우
- 원본: Fake 0.45 (틀림)
- 반전: Fake 0.65 (맞음)
- 평균: 0.55 → Fake (보정됨!) ✅
```

#### 2. 추론 시간 증가

**영향**:
- 40프레임 × 2 (원본+반전) = 80프레임 처리
- 추론 시간: 85~90분 → 140~160분 (+60~70%)
- 제한 시간: 180분 (3시간)
- 여유: 20~40분

**리스크**:
- ⚠️ 시간 초과 가능성 낮음 (여유 충분)
- ⚠️ 만약 초과 시 NUM_FRAMES 감소 (40 → 35)

#### 3. 메모리 사용량

**영향**:
- 배치 크기 2배
- GPU 메모리 증가
- 하지만 배치 단위 처리로 제어됨

**대응**:
- 현재 설정으로 문제없을 것으로 예상
- 만약 OOM 시 NUM_FRAMES 감소

---

## 💡 결론 및 다음 단계

### 실험 요약

**핵심 전략**: 추론 시 데이터 증강 (TTA)

**변경 사항**: 원본 + 좌우 반전 앙상블

**예상 효과**: +1~3% (F1 0.59~0.61)

---

### 다음 실험 계획

#### 시나리오 A: EXP-003 성공 시 (F1 > 0.60)
→ **EXP-004**: FaceForensics++ 파인튜닝
```python
- TTA 유지
- 공개 데이터로 모델 파인튜닝
- 예상: +5~10% 추가 향상
```

#### 시나리오 B: EXP-003 미흡 시 (F1 < 0.59)
→ **EXP-003-v2**: TTA 조합 확장
```python
- 좌우 반전 외 추가
- 회전 (±5도)
- 밝기 조정
- 예상: +2~4% 추가
```

#### 시나리오 C: EXP-003 시간 초과 시
→ **EXP-003-v3**: 프레임 수 조정
```python
- NUM_FRAMES: 40 → 35
- TTA 유지
- 추론 시간: 140~160분 → 120~140분
```

---

### 장기 전략

1. **TTA 확립**
   - 좌우 반전 효과 검증
   - 추가 증강 시도
   - 최적 조합 찾기

2. **파인튜닝 준비**
   - FaceForensics++ 신청
   - 데이터 전처리
   - TTA + 파인튜닝 조합

3. **최종 최적화**
   - 앙상블
   - 하이퍼파라미터 튜닝
   - 추론 시간 최적화

---

## 📝 메모

### 실험 중 관찰 사항
- (결과 나온 후 업데이트)

### TTA 조합 아이디어
```python
# 향후 시도 가능한 TTA
1. 좌우 반전 (현재) ✅
2. 회전 (±5도)
3. 밝기 조정 (±10%)
4. 컬러 jitter
5. 가우시안 블러 (약하게)
```

### 추가 시도할 방법
- TTA 가중치 조정 (원본:반전 = 0.6:0.4?)
- 다중 TTA (원본 + 반전 + 회전)
- Selective TTA (확신 낮은 경우만)

### 참고 사항
- 추론 시간 제한: 3시간
- 하루 제출 제한: 3회
- 최소 제출 간격: 30분
- EXP-002 결과 확인 후 제출

