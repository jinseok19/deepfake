# 🧪 EXP-001: Improved Baseline v1

> **실험일시**: 2024.10.24 20:20:05  
> **실험자**: 기진석  
> **목표**: 베이스라인 개선을 통한 성능 향상

---

## 📊 실험 결과 요약

| 항목 | 값 |
|------|-----|
| **F1 Score** | **0.5354** |
| **베이스라인 대비** | **-2.46%** ❌ |
| **절대 변화** | -0.0135 |
| **순위** | 7위 |
| **추론 시간** | 약 50-60분 (추정) |

**제출 정보**:
- Competition Key: `c346c572-9253-418e-8a95-52cf0afa1611`
- 모델명: `deepfake_improved_v1`
- CUDA 버전: 11.8

---

## 🏗️ 파이프라인 개요

```
이미지/동영상 입력
    ↓
[1️⃣ 전처리] 
 - 동영상 → 30개 프레임 샘플링
 - dlib 얼굴 검출
 - 얼굴 크롭 (또는 중앙 크롭) ⭐
 - 224x224 리사이즈
    ↓
[2️⃣ 모델링]
 - ViT-base 모델 추론
 - 배치(16개) GPU 처리
 - Softmax 확률 출력
    ↓
[3️⃣ 후처리]
 - 프레임 필터링 (얼굴 검출 성공만) ⭐
 - Mean 60% + Max 40% 조합 ⭐
 - Argmax 최종 예측
    ↓
제출 (submission.csv)
```

---

## 1️⃣ 전처리 (Pre-processing)

### 변경 사항
| 항목 | 베이스라인 | EXP-001 | 변경 이유 |
|------|-----------|---------|-----------|
| **얼굴 미검출 처리** | None 반환 → 레이블 0 | **중앙 크롭 → 추론** ⭐ | 정보 손실 방지 |
| 프레임 샘플링 | 30개 균등 샘플링 | 30개 균등 샘플링 | 유지 |
| 얼굴 박스 여유 | margin 1.3배 | margin 1.3배 | 유지 |
| 데이터 증강 | 없음 | 없음 | 미적용 |

### 전처리 파라미터
```python
# 동영상 처리
NUM_FRAMES = 30              # 샘플링 프레임 수
resize_for_detection = 640   # 얼굴 검출용 해상도

# 얼굴 크롭
margin = 1.3                 # 얼굴 박스 1.3배 확대
TARGET_SIZE = (224, 224)     # 모델 입력 크기

# 데이터 증강
horizontal_flip = False      # 미적용
rotation = False             # 미적용
```

### 전처리 로직
```python
# 핵심: 얼굴 미검출 시 중앙 크롭
def detect_and_crop_face(image, target_size=(224, 224)):
    # 1. dlib 얼굴 검출
    faces = face_detector(resized_np, 1)
    
    # 2. 얼굴 없으면 중앙 크롭 (NEW!)
    if not faces:
        return center_crop_image(image, target_size), False
    
    # 3. 얼굴 있으면 1.3배 확대 크롭
    else:
        face_img = crop_with_margin(image, face, margin=1.3)
        return face_img, True

# 동영상 프레임 샘플링
def process_single_file(file_path):
    # VIDEO: 30개 프레임 균등 샘플링
    frame_indices = np.linspace(0, total_frames-1, NUM_FRAMES, dtype=int)
    
    for idx in frame_indices:
        cap.set(cv2.CAP_PROP_POS_FRAMES, idx)
        ret, frame = cap.read()
        face_img, detected = detect_and_crop_face(frame)
        
        face_images.append(face_img)
        face_flags.append(detected)
```

### 전처리 영향 분석
- **중앙 크롭 추가**: 얼굴 미검출 시 중앙 크롭 → **노이즈 발생 가능** ⚠️
- **프레임 샘플링**: 변경 없음 → 0%

**총 전처리 영향**: **-1~2%** (중앙 크롭이 오히려 악영향)

---

## 2️⃣ 모델링 (Modeling)

### 모델 정보
```
모델명: ViT (Vision Transformer)
├─ 베이스: google/vit-base-patch16-224-in21k
├─ 파인튜닝: deep-fake-detector-v2-model
├─ 입력 크기: 224 x 224 x 3
├─ 파라미터 수: ~86M
├─ 출력: [Real 확률, Fake 확률]
└─ 변경 사항: 없음 (베이스라인과 동일)
```

### 모델링 파라미터
```python
# 추론 설정
BATCH_SIZE = 16              # GPU 배치 크기 (베이스라인: 전체 한번에)
device = "cuda"              # GPU 사용
num_workers = 8              # CPU 병렬 워커

# 모델 설정
# 변경 없음 - 베이스라인 모델 그대로 사용
```

### 모델링 변경 사항
- **베이스라인**: 프레임 전체를 한번에 GPU에 올림
- **EXP-001**: 16개씩 배치 처리로 변경
- **효과**: 속도 향상 (메모리 안정성), 정확도 영향 없음

**총 모델링 기여도**: **0%** (속도만 개선)

---

## 3️⃣ 후처리 (Post-processing)

### 변경 사항
| 항목 | 베이스라인 | EXP-001 | 변경 이유 |
|------|-----------|---------|-----------|
| **집계 방식** | Mean only | **Mean 60% + Max 40%** ⭐ | 강한 신호 포착 |
| **프레임 필터링** | 모든 프레임 사용 | **얼굴 검출 성공만 사용** ⭐ | 노이즈 감소 |
| 임계값 | 없음 | 없음 | 미적용 |

### 후처리 파라미터
```python
# 집계 가중치 (NEW!)
MEAN_WEIGHT = 0.6            # 평균 확률 가중치
MAX_WEIGHT = 0.4             # 최대 확률 가중치

# 필터링 설정 (NEW!)
use_face_filter = True       # 얼굴 검출 성공 프레임만 사용
```

### 후처리 로직
```python
def aggregate_video_predictions(probs_list, face_detected_flags):
    """
    30개 프레임 확률 → 1개 최종 예측
    """
    probs_array = np.array(probs_list)  # shape: (30, 2)
    
    # 1. 프레임 필터링 (NEW!)
    detected_indices = np.where(face_detected_flags)[0]
    if detected_indices:
        probs_array = probs_array[detected_indices]
    
    # 2. 확률 집계 (NEW!)
    mean_probs = probs_array.mean(axis=0)  # [Real평균, Fake평균]
    max_probs = probs_array.max(axis=0)    # [Real최대, Fake최대]
    
    # Mean 60% + Max 40% 조합
    combined_probs = MEAN_WEIGHT * mean_probs + MAX_WEIGHT * max_probs
    
    # 3. 최종 예측
    return np.argmax(combined_probs)  # 0 or 1
```

### 후처리 영향 분석
- **Mean+Max 조합**: Max가 노이즈일 수 있음 → **-0.5~1%** ⚠️
- **프레임 필터링**: 정보 손실 가능성 → **-0.5~1%** ⚠️

**총 후처리 영향**: **-1~2%** (오히려 악영향)

---

## 📊 점수 분석

### 전체 성능 변화
```
총 변화: -2.46% (0.5489 → 0.5354)

전처리 영향    -1~2%  ████████ (악영향)
후처리 영향    -1~2%  ████████ (악영향)
모델링 영향    0%     (변경 없음)
```

### 단계별 상세 분석

#### 1️⃣ 전처리 영향 (-1~2%)
**❌ 중앙 크롭 추가**
- 얼굴 미검출 시: 기존(레이블 0) → 개선(중앙 크롭 추론)
- **문제점**: 얼굴이 없는 이미지를 억지로 예측 → 노이즈 발생
- **분석**: 베이스라인의 "얼굴 없으면 Real(0)" 전략이 더 정확했을 가능성
- **가설**: 얼굴 미검출 케이스는 대부분 Real이었을 수 있음
- 기여도: **-1~2%**

#### 2️⃣ 모델링 영향 (0%)
- 모델 자체는 변경 없음
- 배치 처리는 속도만 영향 (정확도 동일)

#### 3️⃣ 후처리 영향 (-0.5~1%)

**❌ Mean + Max 조합**
```
문제점:
프레임 1~29: [0.6, 0.4] (Real)
프레임 30: [0.3, 0.7] (Fake - 노이즈?)

베이스라인 (Mean): 0.59 → Real 예측 (✅)
EXP-001 (Mean+Max): 0.6*0.59 + 0.4*0.7 = 0.634 → 애매 (?)
→ Max가 노이즈를 증폭시킬 수 있음!
```

**❌ 프레임 필터링**
- 중앙 크롭 프레임을 제외하려 했지만
- 오히려 유용한 정보를 버렸을 가능성
- 기여도: **-0.5~1%**

---

## 🔍 가설 검증

### 가설 설정
1. **가설 1**: 얼굴 미검출 시 정보를 버리는 것은 손실이다
   - **근거**: 중앙 부분에도 딥페이크 흔적이 있을 수 있음

2. **가설 2**: 동영상에서 특정 프레임의 강한 신호가 중요하다
   - **근거**: 딥페이크가 특정 각도/순간에만 명확히 나타남

3. **가설 3**: 중앙 크롭 프레임은 노이즈가 될 수 있다
   - **근거**: 얼굴이 아닌 영역을 예측하면 부정확

### 검증 결과
1. **가설 1**: ❌ **실패** (-1~2% 하락)
   - 중앙 크롭이 오히려 노이즈 발생
   - **재분석**: 얼굴 없으면 Real일 확률이 높았음!
   
2. **가설 2**: ❌ **실패** (-0.5~1% 하락)
   - Mean+Max에서 Max가 노이즈를 증폭
   - **재분석**: Mean만 쓰는 게 더 안정적
   
3. **가설 3**: ✅ **성공했지만 역효과**
   - 프레임 필터링이 정보 손실 유발
   - **재분석**: 모든 프레임 사용하는 게 나을 수도

### 예상과 다른 점
- **예상**: 중앙 크롭, Mean+Max가 성능 향상
- **실제**: 모든 변경사항이 성능 하락 유발! (-2.46%)
- **교훈**: "개선"이라고 생각한 것들이 오히려 악영향

---

## 💡 최종 정리

### ❌ 실패 요인
1. **[전처리] 중앙 크롭**: 얼굴 없는 이미지 억지 예측 → 노이즈 (-1~2%)
2. **[후처리] Mean+Max**: Max가 노이즈 증폭 → 불안정 (-0.5~1%)
3. **[후처리] 프레임 필터링**: 정보 손실 → 악영향 (-0.5~1%)

### 📉 성과
- F1 0.5489 → 0.5354 (**-2.46%** 하락) ❌
- 순위: 7위
- 모든 "개선" 시도가 역효과

### 🤔 문제점 분석
1. **전처리**: 얼굴 미검출 = Real이라는 베이스라인 전략이 맞았음
2. **후처리**: Mean only가 더 안정적
3. **후처리**: 모든 프레임 사용하는 게 나음
4. **가정의 오류**: "더 많은 정보 = 좋다"는 가정이 틀렸음

---

## 🎯 다음 실험 계획

### 🚨 중요: 베이스라인으로 회귀 필요!

EXP-001의 모든 변경이 역효과였으므로, **베이스라인으로 돌아가야 함**!

### 우선순위 1: **베이스라인 재제출 (검증용)**
**변경 내용**:
```python
# 모든 변경사항 제거 → 베이스라인 원복
- 중앙 크롭 제거 → 얼굴 없으면 레이블 0
- Mean only 사용 → MEAN_WEIGHT=1.0, MAX_WEIGHT=0.0
- 프레임 필터링 제거 → 모든 프레임 사용
```
- **예상 효과**: +2.46% (베이스라인 0.5489 수준 회복)
- **목적**: 베이스라인 점수 재현 가능한지 확인
- **리스크**: 없음

### 우선순위 2: [전처리] 프레임 수 증가 (베이스라인 기반)
**변경 내용**:
```python
# 베이스라인 + 프레임 수만 증가
NUM_FRAMES = 40  # 30 → 40
(다른 변경 없음!)
```
- **예상 효과**: +2~3%
- **근거**: 단순히 정보량만 늘리기
- **리스크**: 추론 시간 증가

### 우선순위 3: [전처리] TTA 적용 (베이스라인 기반)
**변경 내용**:
```python
# 베이스라인 + 좌우 반전만 추가
for flip in [False, True]:
    pred = infer(image, flip=flip)
predictions = mean(predictions)
```
- **예상 효과**: +1~2%
- **근거**: 앙상블 효과, 검증된 기법
- **리스크**: 추론 시간 2배

### ❌ 시도하지 말아야 할 것
- **중앙 크롭**: 이미 실패 확인 (-1~2%)
- **Mean+Max 조합**: 노이즈 증폭 확인 (-0.5~1%)
- **프레임 필터링**: 정보 손실 확인 (-0.5~1%)

---

## 📝 실험 노트

### 특이사항
- dlib 얼굴 검출 실패율이 약 5~10%
- 중앙 크롭이 오히려 노이즈 발생
- 배치 처리로 속도 15~20분 단축 (이건 성공)

### 배운 점 (실패로부터)
1. **"개선"이 항상 좋은 것은 아니다** - 검증 필요!
2. **베이스라인의 단순한 전략이 더 효과적**일 수 있다
3. **얼굴 없음 = Real** 이라는 휴리스틱이 데이터에 맞았음
4. **Max는 노이즈를 증폭**시킬 수 있음 - Mean only가 안정적
5. **정확한 베이스라인 파악**이 중요 (0.5489, 처음에 0.50으로 착각)

### 주의사항
- 하루 3회 제출 제한 (2회 남음)
- 30분 재제출 간격
- 추론 시간 3시간 제한
- **다음은 베이스라인으로 돌아가야 함!**

---

## 🔗 관련 파일

- 제출 노트북: `submit/task.ipynb`
- 베이스라인: `baseline/task.ipynb`
- 파라미터 변경: Cell 15
- 제출 코드: Cell 19

---

**실험 완료일**: 2024.10.24  
**다음 실험**: EXP-002 (베이스라인 재제출)  
**상태**: ❌ 실패 (F1 -2.46% 하락)
